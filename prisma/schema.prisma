generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  name          String
  email         String
  emailVerified Boolean @default(false)
  image         String?

  Cart Cart?
  orders Order[]

  sessions Session[]
  accounts Account[]

  @@unique([email])
  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  expiresAt DateTime
  token     String
  ipAddress String?
  userAgent String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("sessions")
}

model Account {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  @@map("accounts")
}

model Verification {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  identifier String
  value      String
  expiresAt  DateTime

  @@map("verifications")
}

model Product {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name     String
  imageUrl String
  isPizza  Boolean @default(false)

  productItems ProductItem[]
  ingredients  Ingredient[]

  category   Category @relation(fields: [categoryId], references: [id])
  categoryId String

  @@map("products")
}

model ProductItem {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  price Float

  sizeId String?
  size   PizzaSize? @relation(fields: [sizeId], references: [id], onDelete: SetNull)

  typeId String?
  type   PizzaType? @relation(fields: [typeId], references: [id], onDelete: SetNull)

  cartItems CartItem[]
  orderItems OrderItem[]

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String

  @@map("product_items")
}

model Category {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name String @unique

  slug String @unique

  products Product[]

  @@map("categories")
}

model PizzaSize {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  size        Int
  label       String
  productItems ProductItem[]
}

model PizzaType {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  type        String
  productItems ProductItem[]
}

model Ingredient {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name     String @unique
  price    Float
  imageUrl String

  products    Product[]
  ingredients CartItem[]

  @@map("ingredients")
}

model Cart {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  token String

  items CartItem[]

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quantity    Int          @default(1)
  ingredients Ingredient[]

  productItem    ProductItem @relation(fields: [productItemId], references: [id], onDelete: Cascade)
  productItemId String

  cart           Cart        @relation(fields: [cartId], references: [id], onDelete: Cascade)
  cartId String

  @@map("cart_items")
}

model Order {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  token String

  totalAmount Float
  deliveryPrice Float @default(0)
  status      OrderStatus @default(PENDING)
  paymentId   String?

  firstName String
  lastName  String
  email     String
  phone     String
  address   String
  comment   String?

  items OrderItem[]

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId String

  productItem    ProductItem @relation(fields: [productItemId], references: [id])
  productItemId String

  quantity Int

  // Storing snapshots of price and ingredients at the time of order
  price       Float
  ingredients Json[]

  @@map("order_items")
}

enum OrderStatus {
  PENDING
  SUCCEEDED
  CANCELLED
}

enum UserRole {
  USER
  ADMIN
}